# OpenCloud Helm Chart Values
# This is a YAML-formatted file with configuration values for the OpenCloud Helm chart.
# The file is organized into logical sections for different components of the system.

# =====================================================================
# SECURITY WARNING
# =====================================================================
# IMPORTANT: The following default credentials MUST be changed in production environments.
# Using these default values in production is a significant security risk.
#
# Credentials that need to be changed:
# 1. Keycloak Admin: adminUser: admin, adminPassword: admin
# 2. OpenCloud Admin: adminPassword: admin
# 3. PostgreSQL: user: keycloak, password: keycloak
# 4. MinIO: rootUser: opencloud, rootPassword: opencloud-secret-key


# =====================================================================
# GLOBAL SETTINGS
# =====================================================================

# Global settings that apply across components
global:
  # Domain settings for various services
  domain:
    # Main domain for OpenCloud
    opencloud: cloud.opencloud.test
    # Domain for Keycloak
    oidc: keycloak.opencloud.test
    # Domain for MinIO
    minio: minio.opencloud.test
    # Domain for WOPI server
    wopi: wopiserver.opencloud.test
    # Domain for Collabora CODE
    collabora: collabora.opencloud.test
    # Domain for Companion
    companion: companion.opencloud.test

  # TLS settings for secure connections
  tls:
    # Enable TLS (set to false when using gateway TLS termination externally)
    enabled: false
    # secretName for TLS certificate
    secretName: ""

  # Global storage settings
  storage:
    # Storage class for persistent volumes
    storageClass: ""

  # Global image settings
  image:
    # Global registry override - if set, it will override all image registries
    # Example: my-private-registry.com
    registry: ""
    # Global pull policy override - if set, it will override all image pull policies
    # Options: Always, IfNotPresent, Never
    pullPolicy: ""

# =====================================================================
# UTILITY IMAGES
# =====================================================================

# Busybox image settings (used for init containers)
busybox:
  image:
    # Busybox image registry
    registry: docker.io
    # Busybox image repository
    repository: library/busybox
    # Busybox image tag
    tag: "1.37"
    # Image pull policy
    pullPolicy: IfNotPresent

# =====================================================================
# IDENTITY PROVIDER (OIDC)
# =====================================================================

# OIDC (OpenID Connect) settings for identity and access management
# OpenCloud requires an OIDC provider for authentication. You can either:
# 1. Use the built-in Keycloak instance (oidc.enabled: true)
# 2. Use an external OIDC provider (oidc.enabled: false and configure oidc.external)
#    Supports any OIDC-compliant provider (Keycloak, Auth0, Okta, Azure AD, etc.)
oidc:
  # Enable built-in Keycloak instance
  # When enabled, deploys a pre-configured Keycloak instance with OpenCloud realm
  # When disabled, you must provide external OIDC provider configuration below
  enabled: true
  
  # Keycloak image settings
  image:
    # Keycloak image registry
    registry: quay.io
    # Keycloak image repository
    repository: keycloak/keycloak
    # Keycloak image tag
    tag: "26.5.2"
    # Image pull policy
    pullPolicy: IfNotPresent
  
  # Number of Keycloak replicas
  replicas: 1

  # Use existing secret for keycloak credentials (Note: secretKeyName must be adminUser and adminPassword)
  existingSecret: ""

  # Admin user
  # ignored if oidc.existingSecret is set
  adminUser: admin

  # Admin password
  # ignored if oidc.existingSecret is set
  adminPassword: admin

  # Keycloak realm
  realm: "openCloud"

  # CORS settings for cross-origin requests
  cors:
    # Enable CORS
    enabled: true
    # Allow all origins
    allowAllOrigins: true
    # Allowed origins (used if allowAllOrigins is false)
    origins: []
    # Allowed methods
    methods: "GET,POST,PUT,DELETE,OPTIONS"
    # Allowed headers
    headers: "Origin,Accept,Authorization,Content-Type,Cache-Control"
    # Exposed headers
    exposedHeaders: "Access-Control-Allow-Origin,Access-Control-Allow-Credentials"
    # Allow credentials
    allowCredentials: "true"
    # Max age in seconds
    maxAge: "3600"
  
  # Resources
  resources: {}

  # External OIDC Provider Configuration
  # Used when oidc.enabled is false
  # Supports any OIDC-compliant provider (Keycloak, Auth0, Okta, Azure AD, Google, etc.)
  external:
    # OIDC Issuer URL (required when using external OIDC)
    # This is the base URL of your OIDC provider's authorization server
    # Examples:
    #   Keycloak: https://keycloak.example.com/realms/openCloud
    #   Auth0: https://your-tenant.auth0.com
    #   Okta: https://your-org.okta.com/oauth2/default
    #   Azure AD: https://login.microsoftonline.com/{tenant-id}/v2.0
    #   Google: https://accounts.google.com
    issuerUrl: ""
    
    # OIDC Client ID (required when using external OIDC)
    # The client ID registered in your OIDC provider for OpenCloud
    clientId: "web"
    
    # Account Management URL (optional)
    # URL where users can manage their accounts (profile, password, etc.)
    # If not set, OpenCloud will attempt to construct this from the issuerUrl
    # Examples:
    #   Keycloak: https://keycloak.example.com/realms/openCloud/account
    #   Auth0: https://your-tenant.auth0.com/u/login
    #   Okta: https://your-org.okta.com/enduser/settings
    accountUrl: ""

# PostgreSQL settings for Keycloak (only used when oidc.enabled is true)
postgres:
  # Enable PostgreSQL (set to false when using external OIDC / external OIDC provider database)
  enabled: true
  # PostgreSQL image settings
  image:
    # PostgreSQL image registry
    registry: docker.io
    # PostgreSQL image repository
    repository: postgres
    # PostgreSQL image tag - using latest stable (18) with bookworm (Debian) base for reliability
    tag: "18-bookworm"
    # Image pull policy
    pullPolicy: IfNotPresent

  # Database name
  database: keycloak

  # Use existing secret for postgres credentials (Note: secretKeyName must be username and password)
  existingSecret: ""

  # Database user
  # ignored if postgres.existingSecret is set
  user: keycloak

  # Database password
  # ignored if postgres.existingSecret is set
  password: keycloak

  # Resources allocation
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Persistence configuration
  persistence:
    enabled: true
    # Name of existing PVC to use (overrides all other persistence values)
    existingClaim: ""
    # Size of the persistent volume
    size: 1Gi
    # Storage class
    storageClass: ""
    # Access mode
    accessMode: ReadWriteOnce


# =====================================================================
# EXTENSIONS
# =====================================================================

# Tika settings for full-text search
tika:
  # Enable Tika
  enabled: true
  # Tika image settings
  image:
    # Tika image registry
    registry: docker.io
    # Tika image repository
    repository: apache/tika
    # Tika image tag
    tag: "3.2.3.0-full"
    # Image pull policy
    pullPolicy: IfNotPresent
  # Resources allocation
  resources:
    requests:
      cpu: 100m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 3Gi

# Web Extensions settings
webExtensions:
  # Enable web extensions
  enabled: true
  # Common image settings for all extensions
  image:
    # Registry for web extensions
    registry: docker.io
    # Repository for web extensions
    repository: opencloudeu/web-extensions
    # Image pull policy
    pullPolicy: IfNotPresent
  # List of extensions to install
  extensions:
    # Draw.io extension
    drawio:
      enabled: true
      tag: draw-io-1.0.1
    # External Sites extension
    externalsites:
      enabled: true
      tag: external-sites-1.3.0
    # Importer extension
    importer:
      enabled: true
      tag: importer-1.0.0
    # JSON Viewer extension
    jsonviewer:
      enabled: true
      tag: json-viewer-1.0.2
    # Progress Bars extension
    progressbars:
      enabled: true
      tag: progress-bars-1.1.0
    # Unzip extension
    unzip:
      enabled: true
      tag: unzip-1.0.4

# =====================================================================
# COLLABORATION (COLLABORA)
# =====================================================================

collabora:
  enabled: true
  image:
    registry: docker.io
    repository: collabora/code
    pullPolicy: IfNotPresent
    tag: 25.04.8.3.1
  ssl:
    enabled: false
    verification: true

  existingSecret: ""

  admin:
    username: admin

    # ignored if collabora.existingSecret is set
    password: admin

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1
      memory: 1Gi

  # External Collabora service configuration
  # Use these settings when Collabora runs outside this chart (can be another k8s service
  # or an external host). Protocol is used for readiness checks (http/https).
  external:
    enabled: false
    # Hostname or IP of the external Collabora endpoint (cluster-local service name or external host)
    host: collabora-collabora-online
    # Port number of the external Collabora endpoint
    port: 9980
    # Protocol to use for readiness checks (http or https)
    protocol: http

# =====================================================================
# Collaboration
# =====================================================================

# Top-level configuration for the standalone collaboration (WOPI) service.
# Note: no 'enabled' flag here â€” the collaboration service is required when
# collabora or collabora.external are used.
collaboration:
  # Enable Collaboration
  enabled: true
  # Number of replicas (Note: When using multiple replicas, persistence should be disabled
  # or use a storage class that supports ReadWriteMany access mode)
  replicas: 1
  # Resource requests/limits for the collaboration service (WOPI)
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 5000m
      memory: 10Gi

  # Additional environment variables for the collaboration service
  env: []
  
# =====================================================================
# OPENCLOUD CORE
# =====================================================================

# Image settings for OpenCloud
image:
  # OpenCloud image registry
  registry: docker.io
  # OpenCloud image repository
  repository: opencloudeu/opencloud-rolling
  # OpenCloud image tag
  tag: "5.0.2"
  # Image pull policy
  pullPolicy: IfNotPresent
  # Image pull secrets
  pullSecrets: []

# OpenCloud core settings
opencloud:
  # Enable OpenCloud
  enabled: true
  # Number of replicas (Note: When using multiple replicas, persistence should be disabled
  # or use a storage class that supports ReadWriteMany access mode)
  replicas: 1
  # Log level
  logLevel: info
  # Log color
  logColor: false
  # Log pretty
  logPretty: false
  # Insecure mode (for self-signed certificates)
  insecure: true
  
  # Use existing secret for opencloud admin credentials (Note: secretKeyName must be adminPassword)
  existingSecret: ""
  
  # Admin password
  # ignored if opencloud.existingSecret is set
  adminPassword: admin
  
  # Create demo users
  createDemoUsers: false
  # Additional services to start
  additionalServices: []
  # Services to exclude from starting
  excludeServices:
    - "idp"
  env: []
  envFrom: []
  # Resources allocation
  resources:
    requests:
      cpu: 128m
      memory: 128Mi
    limits:
      memory: 20Gi
  # Persistence configuration
  persistence:
    config:
      # Enable persistence
      enabled: true
      # Name of existing PVC to use (overrides all other persistence values)
      existingClaim: ""
      # Size of the persistent volume for config
      size: 5Gi
      # Storage class
      storageClass: ""
      # Access mode (ReadWriteOnce or ReadWriteMany for multiple replicas)
      accessMode: ReadWriteOnce
    data:
      # Enable persistence
      enabled: true
      # Name of existing PVC to use (overrides all other persistence values)
      existingClaim: ""
      # Size of the persistent volume for data
      size: 30Gi
      # Storage class
      storageClass: ""
      # Access mode (ReadWriteOnce or ReadWriteMany for multiple replicas)
      accessMode: ReadWriteOnce
  # Configuration files
  config:
    theme: "owncloud"
    # App registry configuration
    appRegistry: {}
    # CSP configuration
    csp: {}
    # Banned password list configuration
    # Format: Multi-line string (not YAML array)
    # Use the |- syntax to preserve line breaks
    # Add one password per line - do not use YAML list syntax (no dashes)
    # Example:
    #   bannedPasswordList: |-
    #     password1
    #     password2
    #     password3
    # For very long lists override the file 'files/opencloud/banned-password-list.txt'
    bannedPasswordList: |-

  nats:
    external:
      # -- Use an external NATS messaging system instead of the internal one.
      # Recommended for all production instances.
      # Needs to be used if HighAvailability is needed.
      # Needs to be used if OpenCloud shall be used by more than a 2-digit user count.
      enabled: false

      # -- Endpoint of the messaging system.
      endpoint: nats.opencloud-nats.svc.cluster.local:4222

      # -- Cluster name to use with the messaging system.
      cluster: opencloud-cluster

      tls:
        # -- Enables TLS encrypted communication with the messaging system.
        # Recommended for production installations.
        enabled: false
        
        # -- Set only to false, if the certificate of your messaging system service is not trusted.
        # If set to false, you need to put the CA cert of the messaging system server into the secret referenced by "caSecretName"
        certTrusted: true

        # -- Disables SSL certificate checking for connections to the messaging system server.
        # -- For self signed certificates, consider to put the CA cert of the messaging system secure server into the secret referenced by "caSecretName"
        # Not recommended for production installations.
        insecure: false

        # Use existing CA secret for nats credentials (Note: secretKeyName must be 'ca.crt' with the root CA certificate for NATS)
        # Only used if certTrusted is false
        caSecretName : opencloud-nats-ca

  # =====================================================================
  # EMAIL (SMTP)
  # =====================================================================
  
  # SMTP settings for email notifications
  smtp:
    # Enable SMTP
    enabled: false
    # SMTP host
    host: ""
    # SMTP port
    port: "587"
    # SMTP sender
    sender: ""
    
    # Use existing secret for opencloud smtp credentials (Note: secretKeyName must be smtpUser and smtpPassword)
    existingSecret: ""
    
    # SMTP username
    # ignored if opencloud.smtp.existingSecret is set
    username: ""

    # SMTP password
    # ignored if opencloud.smtp.existingSecret is set
    password: ""

    # SMTP insecure (allow self-signed certificates)
    insecure: "false"
    # SMTP authentication method
    authentication: "plain"
    # SMTP encryption method
    encryption: "starttls"

  # =====================================================================
  # STORAGE CONFIGURATION
  # =====================================================================
  
  # Storage configuration
  storage:
    # Storage mode for user files, can be "s3" (default) or "posixfs"
    mode: s3
    # S3 storage configuration
    s3:
      enabled: true
      # MinIO image settings
      image:
        registry: docker.io
        repository: minio/minio
        tag: latest
        pullPolicy: IfNotPresent
      # httpRoute configuration
      httpRoute:
        enabled: false
      existingSecret: ""
      rootUser: opencloud
      rootPassword: opencloud-secret-key
      bucketName: opencloud-bucket
      region: "default"
      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 2Gi
      persistence:
        enabled: true
        existingClaim: ""
        size: 30Gi
        storageClass: ""
        accessMode: ReadWriteOnce
      # External S3 (can be S3, Ceph, or external MinIO)
      external:
        # External S3 endpoint URL (no 'enabled' field anymore)
        endpoint: ""
        region: "default"
        existingSecret: ""
        accessKey: ""
        secretKey: ""
        bucket: ""
        createBucket: true
    posixfs:
      # The type of the cache store, supported values are: 'memory', 'redis-sentinel', 'nats-js-kv' (default), 'noop'
      idCacheStore: nats-js-kv
      # Path of storage root directory, default is /var/lib/opencloud/storage
      rootPath: "/var/lib/opencloud/storage"
      persistence:
        # Enable persistence
        enabled: true
        # Name of existing PVC to use (overrides all other persistence values)
        existingClaim: ""
        # Size of the persistent volume for data
        size: 30Gi
        # Storage class
        storageClass: ""
        # Access mode (ReadWriteOnce or ReadWriteMany for multiple replicas)
        accessMode: ReadWriteMany

# =====================================================================
# GATEWAY-API HTTPRoute
# =====================================================================

# Requires Gateway API resources and suitable controller installed within the cluster
# (see: https://gateway-api.sigs.k8s.io/guides/)
httpRoute:
  # Enable HTTPRoute resources (set to true to create Gateway API routes)
  enabled: false

  # Gateway configuration
  gateway:
    # Create the gateway
    create: false
    # HTTPS Port to listen to (k3s traefik defaults to 8443)
    port: 443
    # Gateway name
    name: opencloud-gateway
    # Gateway class (defaults to "cilium")
    className: cilium
    # Gateway namespace (defaults to Release.Namespace)
    namespace: ""
    # Gateway section name (applies to all routes). If set to a non-empty value, this overrides the default component-specific section names (e.g., opencloud-https) for all routes. If left empty, the defaults are used.
    sectionName: ""
    # Gateway annotations
    annotations:
    # Gateway annotations
    infrastructure:
      annotations: {}

# =====================================================================
# INGRESS
# =====================================================================

# Ingress configuration
ingress:
  # Whether to enable ingress resources for components
  enabled: false

  # The ingress class name to use (e.g., nginx, traefik). Leave empty to use the cluster default.
  # Note: This sets the Kubernetes `spec.ingressClassName` field.
  ingressClassName: ""

  # Custom annotations applied to all ingress resources.
  # These are merged with any annotations from 'annotationsPreset' (if set).
  annotations: {}
    # Example:
    # cert-manager.io/cluster-issuer: letsencrypt
